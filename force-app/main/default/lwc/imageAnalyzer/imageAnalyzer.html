<template>
    <div class="ai-glass-card">
        <div class="ai-header">
            <div class="ai-avatar">
                <svg viewBox="0 0 64 64" class="ai-hero-icon">
                  <circle cx="32" cy="32" r="30" fill="#ffe4ea"/>
                  <g>
                      <rect x="24" y="20" width="16" height="24" rx="6" fill="#e43c54"/>
                      <ellipse cx="32" cy="32" rx="6" ry="6" fill="#fff"/>
                  </g>
                </svg>
            </div>
            <div>
                <div class="ai-title">File Analyzer <span class="ai-blink">✨</span></div>
                <div class="ai-caption">Let AI review your Bills instantly</div>
            </div>
        </div>

        <!-- NEW: Tabbed interface for file selection -->
        <lightning-tabset active-tab-value="upload" variant="scoped">
            <lightning-tab label="Upload New File" value="upload">
                <div class="ai-upload-wrapper slds-p-around_medium">
                    <lightning-file-upload
                        label="Upload Image or PDF"
                        name="uploadFile"
                        multiple="false"
                        accept=".jpg,.jpeg,.png,.pdf"
                        record-id={recordId}
                        onuploadfinished={fileUploadHandler}>
                    </lightning-file-upload>
                </div>
            </lightning-tab>
            <lightning-tab label="Select Existing File" value="existing">
                <div class="slds-p-around_medium">
                    <!-- Show combobox if files exist -->
                    <template if:true={hasFiles}>
                        <lightning-combobox
                            name="existingFiles"
                            label="Choose a file from this record"
                            value={uploadedFileId}
                            placeholder="Select a file..."
                            options={fileOptions}
                            onchange={handleFileSelectionChange}>
                        </lightning-combobox>
                    </template>
                    <!-- Show message if no files exist -->
                    <template if:false={hasFiles}>
                        <div class="slds-text-align_center slds-p-vertical_medium slds-text-color_weak">
                            No existing files found on this record.
                        </div>
                    </template>
                </div>
            </lightning-tab>
        </lightning-tabset>

        <!-- Display the name of the selected file -->
        <template if:true={uploadedFileName}>
            <div class="ai-uploaded-file slds-m-left_medium slds-m-right_medium">
                <lightning-icon icon-name="doctype:image" size="x-small"></lightning-icon>
                <span class="ai-uploaded-file-name">{uploadedFileName}</span>
            </div>
        </template>

        <!-- Analyze Button -->
        <lightning-button
            variant="brand"
            label="Analyze Selected File"
            icon-name="utility:einstein"
            class="ai-analyze-btn slds-m-top_medium"
            disabled={disableAnalyzeButton}
            onclick={handleAnalyzeFiles}>
        </lightning-button>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="ai-loading">
                <div class="ai-loader"></div>
                <span class="ai-analyzing">Analyzing with AI…</span>
            </div>
        </template>

        <!-- Error Message -->
        <template if:true={errorMessage}>
            <div class="ai-error">
                <lightning-icon icon-name="utility:error" size="x-small"></lightning-icon>
                <span>{errorMessage}</span>
            </div>
        </template>

        <!-- AI Analysis Result + Actions -->
        <template if:true={aiResult}>
            <div class="ai-result">
                <lightning-icon icon-name="utility:bot" size="small"></lightning-icon>
                <lightning-formatted-rich-text value={aiResult}></lightning-formatted-rich-text>
            </div>
            <div class="ai-actions-group">
                <lightning-button-group>
                    <lightning-button
                        variant="neutral"
                        label="Copy"
                        icon-name="utility:copy"
                        onclick={handleCopyToClipboard}>
                    </lightning-button>
                    <lightning-button
                        variant="neutral"
                        label="Start Flow"
                        icon-name="utility:flow"
                        onclick={handleStartFlow}>
                    </lightning-button>
                </lightning-button-group>
                <template if:true={showActionToast}>
                    <div class="ai-action-toast">{actionToastMessage}</div>
                </template>
            </div>
        </template>
    </div>
</template>
